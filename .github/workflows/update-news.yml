name: Update World + Côte d'Ivoire News

on:
  schedule:
    - cron: '0 8 * * *' # Tous les jours à 08h UTC
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest

    env:
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch world headlines
        run: |
          curl "https://newsapi.org/v2/top-headlines?language=en&country=us&apiKey=$NEWS_API_KEY" \
            -o world.json

      - name: Add Côte d’Ivoire headlines
        run: |
          echo '[
            {
              "en": "Côte d’Ivoire: four dead in stadium stampede after RHDP meeting",
              "fr": "Côte d’Ivoire : quatre morts dans une bousculade après le meeting du RHDP",
              "link": "https://information.tv5monde.com/afrique/cote-divoire-quatre-morts-dans-une-bousculade-apres-le-meeting-du-parti-au-pouvoir-2778479"
            },
            {
              "en": "Technical incident at Abidjan Port quickly resolved",
              "fr": "Côte d’Ivoire : incident technique au Port d’Abidjan rapidement maîtrisé",
              "link": "https://www.koaci.com/article/2025/06/24/cote-divoire/societe/cote-divoire-port-dabidjan-un-incident-technique-sur-un-navire-rapidement-maitrise_187958.html"
            }
          ]' > ivoire.json

      - name: Combine world + Côte d’Ivoire headlines
        run: |
          jq -s '.[0].articles + .[1]' world.json ivoire.json > titres.json

      - name: Commit updated headlines
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
          git pull --rebase
          git add titres.json
          git commit -m "📰 Mise à jour quotidienne des titres d’actualités" || echo "✅ Aucun changement à commiter"
          git push || echo "❌ Push échoué"
